# =============================================================================
# DOCKER NGINX CONFIGURATION
# =============================================================================
# Port 80: Public routes (exposed as :8082 to host)
# Port 81: Admin routes (exposed as :8083 to host - private)
# =============================================================================

# =============================================================================
# Connection header handling for WebSocket vs regular HTTP
# =============================================================================
# This map ensures Connection header is only set to 'upgrade' for WebSocket
# requests, not for regular HTTP requests like file uploads (critical for mobile!)
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      '';
}

# =============================================================================
# PUBLIC SERVER (Port 80) - For regular users
# =============================================================================
server {
    listen 80;
    server_name liberotips.com;

    # Return 429 instead of 503 for rate limiting
    limit_req_status 429;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Proxy Settings
    client_max_body_size 10M;
    proxy_read_timeout 60s;

    # Friendly 429 Error
    error_page 429 /429.json;
    location = /429.json {
        return 429 '{"error": "Too Many Requests", "message": "Please try again later."}';
        add_header Content-Type application/json;
    }

    # ===========================================
    # BLOCK ADMIN ROUTES ON PUBLIC PORT
    # ===========================================
    # Return 404 to hide existence of admin panel
    location /admin {
        return 404;
    }
    
    location /api/admin {
        return 404;
    }

    # ===========================================
    # PUBLIC ROUTES
    # ===========================================

    # Favicon redirect
    location = /favicon.ico {
        proxy_pass http://client:3001/branding/favicon.ico;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Frontend Static Assets (No Rate Limit)
    location /_next/ {
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Frontend
    location / {
        limit_req zone=general_zone burst=100 nodelay;
        
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Uploads (served by backend)
    location /uploads/ {
        proxy_pass http://app:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache static uploads
        expires 7d;
        add_header Cache-Control "public, immutable";

       # CORS headers for cross-origin image loading (admin on port 857)
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;

    }

    # API (general)
    location /api/ {
        limit_req zone=general_zone burst=50 nodelay;
        
        proxy_pass http://app:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Auth Login/Refresh Rate Limiting (Strict)
    location ~ ^/api/auth/(login|refresh)$ {
        limit_req zone=login_zone burst=5 nodelay;
        
        proxy_pass http://app:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Signup/Forgot-password/Reset-password Rate Limiting (Very Strict)
    location ~ ^/api/auth/(signup|forgot-password|reset-password|resend-verification-email)$ {
        limit_req zone=signup_zone burst=3 nodelay;
        
        proxy_pass http://app:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Webhooks
    location /api/webhooks/ {
        limit_req zone=general_zone burst=50 nodelay;
        
        proxy_pass http://app:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


# =============================================================================
# ADMIN SERVER (Port 81) - Private, only accessible via VPN/internal network
# =============================================================================
server {
    listen 81;
    server_name liberotips.com;

    # Return 429 instead of 503 for rate limiting
    limit_req_status 429;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Proxy Settings
    client_max_body_size 10M;
    proxy_read_timeout 60s;

    # Friendly 429 Error
    error_page 429 /429.json;
    location = /429.json {
        return 429 '{"error": "Too Many Requests", "message": "Please try again later."}';
        add_header Content-Type application/json;
    }

    # ===========================================
    # ADMIN ROUTES
    # ===========================================

    # Admin Frontend Pages
    location /admin {
        limit_req zone=admin_zone burst=20 nodelay;
        
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Admin API - with extended timeouts for mobile uploads
    location /api/admin {
        limit_req zone=admin_zone burst=20 nodelay;
        
        proxy_pass http://app:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Extended timeouts for slow mobile connections uploading images
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # Ensure request body is fully buffered for multipart uploads
        proxy_request_buffering on;
        proxy_buffering on;
    }

    # ===========================================
    # SUPPORTING ROUTES (needed for admin to function)
    # ===========================================

    # Favicon
    location = /favicon.ico {
        proxy_pass http://client:3001/branding/favicon.ico;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Frontend Static Assets (No Rate Limit)
    location /_next/ {
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Uploads (for viewing bet images in admin)
    location /uploads/ {
        proxy_pass http://app:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Cross-Origin-Resource-Policy "cross-origin" always;
    }

    # Auth endpoints (admin needs to login)
    location /api/auth/ {
        limit_req zone=login_zone burst=5 nodelay;
        
        proxy_pass http://app:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Other API endpoints (categories, packs, users, etc. used by admin)
    location /api/ {
        limit_req zone=admin_zone burst=20 nodelay;
        
        proxy_pass http://app:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Login page (admin needs to access /login to authenticate)
    location /login {
        limit_req zone=general_zone burst=10 nodelay;
        
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Branding assets (logo, favicon, etc.)
    location /branding/ {
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Root path - redirect to /admin
    location = / {
        return 302 /admin;
    }

    # Catch-all for any other static files from Next.js
    # This handles any unmatched routes (should rarely be needed)
    location / {
        proxy_pass http://client:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
