# =============================================================================
# HTTP → HTTPS Redirect (Port 80)
# =============================================================================
server {
    listen 80;
    server_name yourdomain.com;

    # Let's Encrypt certificate renewal challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all HTTP traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}


# =============================================================================
# Connection header handling for WebSocket vs regular HTTP
# =============================================================================
# This map ensures Connection header is only set to 'upgrade' for WebSocket
# requests, not for regular HTTP requests like file uploads
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      '';
}


# =============================================================================
# PUBLIC SERVER - Port 443 (Internet accessible)
# =============================================================================
# Handles all public traffic - regular users access the site here
# Admin routes are blocked and return 404
# =============================================================================
server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    # SSL Configuration (managed by Certbot)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Allow larger file uploads (for consistency with Docker nginx)
    client_max_body_size 5M;

    # ===========================================
    # BLOCK ADMIN ROUTES ON PUBLIC PORT
    # ===========================================
    # Return 404 to hide the existence of admin panel
    location /admin {
        return 404;
    }
    
    location /api/admin {
        return 404;
    }

    # ===========================================
    # PUBLIC ROUTES → Docker Nginx (Port 8082)
    # ===========================================
    location / {
        proxy_pass http://localhost:8082;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeout settings for long-running requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}


# =============================================================================
# ADMIN SERVER - Port 857 (VPN/Internal Network ONLY)
# =============================================================================
# This port should be BLOCKED from the internet via firewall
# Only accessible via VPN or from within the internal network
#
# Access URL: https://yourdomain.com:857/admin
# =============================================================================
server {
    listen 857 ssl http2;
    server_name liberotips.com;

    # SSL Configuration (same certs as public)
    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

    # Allow larger file uploads (for bet images)
    client_max_body_size 5M;

    # ===========================================
    # IP ALLOWLIST - CUSTOMIZE THIS SECTION
    # ===========================================
    # Only these IPs/networks can access the admin panel
    # Uses CIDR notation for network ranges
    #
    # Common VPN subnets:
    #   OpenVPN default:    10.8.0.0/24
    #   WireGuard example:  10.200.200.0/24
    #
    # Private network ranges:
    #   Class A: 10.0.0.0/8
    #   Class B: 172.16.0.0/12
    #   Class C: 192.168.0.0/16
    # ===========================================

        allow ip_address;
        allow ip_address;
        allow ip_address;    
        deny all;

    # ===========================================
    # ALL ROUTES → Docker Nginx Admin Port (8083)
    # ===========================================
    location / {
        proxy_pass http://localhost:8083;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Extended timeouts for slow mobile connections
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        
        # Buffer settings for file uploads
        proxy_request_buffering on;
        proxy_buffering on;
    }
}
